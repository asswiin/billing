<!DOCTYPE html>
<html lang="en">
<head>
    <title>Bill History</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="/billing/global.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .content-container {
            flex: 1;
            padding: 1rem 2rem;
        }
    </style>
</head>
<body>
    <!-- Include the topbar -->
    <div id="topbarContainer"></div>
    
    <div class="content-container">
        <h1>Bill History</h1>
        <section class="glass">
            <input type="text" id="billSearch" placeholder="Search by Product Name..." style="margin-bottom:1.5rem;">
            <div id="billList" class="card-list"></div>
        </section>
        <div id="billModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;align-items:center;justify-content:center;">
            <div class="glass" style="max-width:400px;margin:auto;position:relative;">
                <button onclick="closeModal()" style="position:absolute;top:1rem;right:1rem;background:#ef4444;">Close</button>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>
    
    <script>
        let bills = [];
        let products = [];

        // Fetch products for name lookup
        async function fetchProducts() {
            const res = await fetch('/billing/server.php?action=getProducts');
            products = await res.json();
        }

        // Fetch bills
        async function fetchBills() {
            const res = await fetch('/billing/server.php?action=getBills');
            bills = await res.json();
            renderBills();
        }

        // Get product name by id
        function getProductName(id) {
            const p = products.find(prod => prod._id.$oid === id);
            return p ? p.name : id;
        }

        // Render bills as cards
        function renderBills(filter = '') {
            const list = document.getElementById('billList');
            let filtered = bills;
            if (filter) {
                filtered = bills.filter(bill => getProductName(bill.productId.$oid || bill.productId).toLowerCase().includes(filter.toLowerCase()));
            }
            list.innerHTML = filtered.map(bill => `
                <div class="card">
                    <div class="card-title">${getProductName(bill.productId.$oid || bill.productId)}</div>
                    <div class="card-meta">Quantity: ${bill.quantity}</div>
                    <div class="card-meta">Total: ₹${bill.total.toFixed(2)}</div>
                    <div class="card-meta">Date: ${new Date(bill.date.$date).toLocaleString()}</div>
                    <div class="card-actions">
                        <button onclick="expandBill('${bill._id.$oid || bill._id}')">View Details</button>
                    </div>
                </div>
            `).join('');
        }

        // Expand bill modal
        window.expandBill = function(billId) {
            const bill = bills.find(b => (b._id.$oid || b._id) === billId);
            if (!bill) return;
            const productName = getProductName(bill.productId.$oid || bill.productId);
            document.getElementById('modalContent').innerHTML = `
                <h2>Bill Details</h2>
                <p><b>Product:</b> ${productName}</p>
                <p><b>Quantity:</b> ${bill.quantity}</p>
                <p><b>Total:</b> ₹${bill.total.toFixed(2)}</p>
                <p><b>Date:</b> ${new Date(bill.date.$date).toLocaleString()}</p>
                <p><b>Bill ID:</b> ${(bill._id.$oid || bill._id)}</p>
            `;
            document.getElementById('billModal').style.display = 'flex';
        };

        window.closeModal = function() {
            document.getElementById('billModal').style.display = 'none';
        };

        // Search filter
        document.getElementById('billSearch').addEventListener('input', function() {
            renderBills(this.value.trim());
        });

        // On page load
        fetchProducts().then(fetchBills);
    </script>

    <!-- Script to load the topbar -->
    <script>
        // Load the topbar
        fetch('/billing/ui/topbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('topbarContainer').innerHTML = data;
                
                // Set user session data for staff page
                window.userSessionData = {
                    name: '<?php echo isset($_SESSION["username"]) ? $_SESSION["username"] : "Staff"; ?>',
                    role: '<?php echo isset($_SESSION["user_role"]) ? $_SESSION["user_role"] : "staff"; ?>',
                    email: 'staff@example.com'
                };
                
                // Execute the topbar script manually
                const scripts = document.getElementById('topbarContainer').querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    Array.from(script.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.textContent = script.textContent;
                    document.getElementById('topbarContainer').appendChild(newScript);
                });
            })
            .catch(error => console.error('Error loading topbar:', error));
    </script>
</body>
</html>
